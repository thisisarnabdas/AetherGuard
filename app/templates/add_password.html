{% extends "base.html" %}
{% block content %}
<div class="container fade-in">
    <div class="content-wrapper" style="max-width: 400px; margin: 0 auto; padding: var(--spacing-lg); background-color: var(--surface); border-radius: var(--radius-md);">
        <h2 class="app-title" style="margin-bottom: var(--spacing-lg);">Add New Password</h2>
        
        <form method="POST" action="{{ url_for('views.add_password') }}" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            {{ form.hidden_tag() }}
            
            <!-- Title Field with Icon -->
            <label style="display: flex; flex-direction: column; gap: var(--spacing-xs); color: var(--text-secondary);">
                <span style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                    </svg>
                    Title
                </span>
                {{ form.title(class="form-control", placeholder="Enter title") }}
            </label>

            <!-- Username Field with Icon -->
            <label style="display: flex; flex-direction: column; gap: var(--spacing-xs); color: var(--text-secondary);">
                <span style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Username
                </span>
                {{ form.username(class="form-control", placeholder="Enter username or email") }}
            </label>

            <!-- Password Field with Icon -->
            <label style="display: flex; flex-direction: column; gap: var(--spacing-xs); color: var(--text-secondary);">
                <span style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Password
                </span>
                {{ form.password(class="form-control", placeholder="Enter password", id="password-field") }}
                
                <!-- Show Password Checkbox -->
                <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-top: var(--spacing-xs);">
                    <input type="checkbox" id="show-password-checkbox" style="width: auto;" onclick="togglePasswordVisibility()">
                    <label for="show-password-checkbox" style="color: var(--text-secondary); font-size: 0.875rem;">Show Password</label>
                </div>

                <!-- Password Strength Indicator -->
                <div class="password-strength" id="password-strength" style="margin-top: var(--spacing-xs);">
                    <div style="display: flex; gap: var(--spacing-xs);">
                        <div class="strength-bar" id="strength-bar-1" style="height: 4px; flex: 1; border-radius: var(--radius-sm); background: var(--surface-light);"></div>
                        <div class="strength-bar" id="strength-bar-2" style="height: 4px; flex: 1; border-radius: var(--radius-sm); background: var(--surface-light);"></div>
                        <div class="strength-bar" id="strength-bar-3" style="height: 4px; flex: 1; border-radius: var(--radius-sm); background: var(--surface-light);"></div>
                        <div class="strength-bar" id="strength-bar-4" style="height: 4px; flex: 1; border-radius: var(--radius-sm); background: var(--surface-light);"></div>
                    </div>
                    <p id="strength-text" style="color: var(--text-tertiary); font-size: 0.75rem; margin-top: var(--spacing-xs);">Password strength: None</p>
                </div>
            </label>

            <!-- Add Password and Generate Password Buttons (Styled and Aligned as in the Screenshot) -->
            <button type="submit" class="btn" style="display: flex; align-items: center; justify-content: center; padding: var(--spacing-sm) var(--spacing-lg); margin-top: var(--spacing-lg); background: #6C63FF; border-radius: var(--radius-lg);">
                <span>Add Password</span>
            </button>

            <button type="button" onclick="openGeneratePasswordModal()" class="btn" style="display: flex; align-items: center; justify-content: center; padding: var(--spacing-sm) var(--spacing-lg); background: #6C63FF; border-radius: var(--radius-lg);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
                <span>Generate Password</span>
            </button>
        </form>
    </div>
</div>

<!-- Generate Password Modal (Hidden by Default) -->
<div id="generate-password-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="max-width: 500px; margin: 100px auto; padding: var(--spacing-lg); background: var(--surface); border-radius: var(--radius-md);">
        <h3 style="margin-bottom: var(--spacing-md);">Generate Password</h3>
        
        <!-- Password Options Form -->
        <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
                Length:
                <input type="range" id="password-length" min="4" max="64" value="16" style="flex: 1;" oninput="updateLengthDisplay(this.value)">
                <span id="length-display">16</span>
            </label>
            <label><input type="checkbox" id="include-uppercase" checked> Include Uppercase Letters</label>
            <label><input type="checkbox" id="include-lowercase" checked> Include Lowercase Letters</label>
            <label><input type="checkbox" id="include-numbers" checked> Include Numbers</label>
            <label><input type="checkbox" id="include-symbols"> Include Symbols</label>
            
            <!-- Generate and Copy Password -->
            <button onclick="generateCustomPassword()" class="btn" style="margin-top: var(--spacing-md); background: #6C63FF;">Generate Password</button>
            <p id="generated-password-display" style="margin-top: var(--spacing-sm); font-size: 1rem;"></p>
            <button onclick="copyGeneratedPassword()" class="btn" style="margin-top: var(--spacing-sm); background: #6C63FF;">Copy Password to Main Form</button>
        </div>
        
        <button onclick="closeGeneratePasswordModal()" class="btn" style="margin-top: var(--spacing-md); background: var(--danger);">Close</button>
    </div>
</div>

<script>
// Functions for the modal and password generator

// Toggle password visibility
function togglePasswordVisibility() {
    const passwordField = document.getElementById("password-field");
    passwordField.type = document.getElementById("show-password-checkbox").checked ? "text" : "password";
}

// Update password length display for slider
function updateLengthDisplay(value) {
    document.getElementById("length-display").textContent = value;
}

// Open and close modal
function openGeneratePasswordModal() {
    document.getElementById("generate-password-modal").style.display = "block";
}
function closeGeneratePasswordModal() {
    document.getElementById("generate-password-modal").style.display = "none";
}

// Password strength calculation and display
function updatePasswordStrength() {
    const password = document.getElementById("password-field").value;
    const strengthText = document.getElementById("strength-text");
    const strengthBars = [
        document.getElementById("strength-bar-1"),
        document.getElementById("strength-bar-2"),
        document.getElementById("strength-bar-3"),
        document.getElementById("strength-bar-4")
    ];

    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z\d]/.test(password)) strength++;

    const strengthLevels = ["var(--danger)", "var(--warning)", "var(--primary)", "var(--success)"];
    strengthBars.forEach((bar, index) => {
        bar.style.background = index < strength ? strengthLevels[strength - 1] : "var(--surface-light)";
    });

    const strengthLabels = ["Weak", "Fair", "Good", "Strong"];
    strengthText.textContent = strength ? `Password strength: ${strengthLabels[strength - 1]}` : "Password strength: None";
    strengthText.style.color = strengthLevels[strength - 1] || "var(--text-tertiary)";
}

// Event listener to update password strength on input
document.getElementById("password-field").addEventListener("input", updatePasswordStrength);

// Generate password based on selected options
function generateCustomPassword() {
    const length = parseInt(document.getElementById("password-length").value);
    const includeUppercase = document.getElementById("include-uppercase").checked;
    const includeLowercase = document.getElementById("include-lowercase").checked;
    const includeNumbers = document.getElementById("include-numbers").checked;
    const includeSymbols = document.getElementById("include-symbols").checked;

    let charset = '';
    if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
    if (includeNumbers) charset += '0123456789';
    if (includeSymbols) charset += '!@#$%^&*()';

    if (charset === '') {
        alert("Please select at least one character type.");
        return;
    }

    let password = '';
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length);
        password += charset[randomIndex];
    }

    document.getElementById("generated-password-display").textContent = password;
}

// Copy generated password to the main form password field
function copyGeneratedPassword() {
    const generatedPassword = document.getElementById("generated-password-display").textContent;
    if (generatedPassword) {
        document.getElementById("password-field").value = generatedPassword;
        updatePasswordStrength(); // Update password strength based on the generated password
        closeGeneratePasswordModal();
    } else {
        alert("Please generate a password first.");
    }
}
</script>
{% endblock %}
